generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mongodb"
  url      = env("DATABASE_URL")
  // Note: Prisma 6 requiert cette ligne `url` dans le schema.prisma
  // Avec Prisma 7+, la configuration sera déplacée dans prisma.config.ts
  // Le fichier prisma.config.ts est déjà prêt pour la migration future
}

model Account {
  id                String   @id @default(auto()) @map("_id") @db.ObjectId
  userId            String   @db.ObjectId
  type              String
  provider          String
  providerAccountId String   @map("provider_account_id")
  refresh_token     String?  @db.String
  access_token      String?  @db.String
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?  @db.String
  session_state     String?
  createdAt         DateTime @default(now()) @map("created_at")
  updatedAt         DateTime @updatedAt @map("updated_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

// Optional for WebAuthn support
model Authenticator {
  credentialID         String  @id @map("_id")
  userId               String  @db.ObjectId
  providerAccountId    String  @map("provider_account_id")
  credentialPublicKey  String  @map("credential_public_key")
  counter              Int
  credentialDeviceType String  @map("credential_device_type")
  credentialBackedUp   Boolean @map("credential_backed_up")
  transports           String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, credentialID])
}

model Domain {
  id               String @id @default(auto()) @map("_id") @db.ObjectId
  longDescription  String
  shortDescription String
  order            Int? // Ordre dans le programme
  discipline       DomainDiscipline? // Discipline dominante pour Physique-Chimie

  // Relations
  subjectId String  @db.ObjectId
  subject   Subject @relation(fields: [subjectId], references: [id])

  themes Theme[]
  scopes DomainScope[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([longDescription, subjectId])
}

model DomainScope {
  id String @id @default(auto()) @map("_id") @db.ObjectId

  domainId String @db.ObjectId
  domain   Domain @relation(fields: [domainId], references: [id])

  diplomaId String?  @db.ObjectId
  diploma   Diploma? @relation(fields: [diplomaId], references: [id])

  gradeId String? @db.ObjectId
  grade   Grade?  @relation(fields: [gradeId], references: [id])

  divisionId String?   @db.ObjectId
  division   Division? @relation(fields: [divisionId], references: [id])

  labelOverride String?
  order         Int?
  isActive      Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([domainId])
  @@index([diplomaId])
  @@index([gradeId])
  @@index([divisionId])
  @@index([domainId, diplomaId, gradeId, divisionId])
}

model Teaching {
  id               String   @id @default(auto()) @map("_id") @db.ObjectId
  longDescription  String // ex: "Spécialité Mathématiques", "Tronc Commun Sciences"
  shortDescription String? // ex: "Spé Maths", "TC Sciences"
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  // Relations
  gradeId String @db.ObjectId
  grade   Grade  @relation(fields: [gradeId], references: [id])

  subjectId String  @db.ObjectId
  subject   Subject @relation(fields: [subjectId], references: [id])

  examPapers ExamPaper[]

  @@unique([longDescription, gradeId])
}

enum TeachingType {
  SPECIALITE
  TRONC_COMMUN
  OPTION
  COMPLEMENTAIRE
  EXPERT
}

enum DomainDiscipline {
  PHYSIQUE
  CHIMIE
  TRANSVERSAL
}

// Programme scolaire (ex: Programmes 2019, Réforme 2020, etc.)
model Curriculum {
  id               String  @id @default(auto()) @map("_id") @db.ObjectId
  longDescription  String // ex: "Programme 2019", "Réforme Bac 2020", "Programme 2010"
  shortDescription String? // Description détaillée du programme

  // Période de validité du programme (mois/année)
  startDate DateTime // Date de mise en vigueur (ex: 2020-09-01 pour septembre 2020)
  endDate   DateTime? // Date de fin (null si toujours en vigueur)

  // Applicabilité (MongoDB: liste d'IDs pour many-to-many)
  // Un programme peut concerner plusieurs enseignements (ex: réforme 2020 pour toutes les spés)
  teachingIds String[] @db.ObjectId

  // Métadonnées
  isActive Boolean @default(true) // Programme actuellement en vigueur
  notes    String? // Notes complémentaires

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  examPapers ExamPaper[]

  @@unique([longDescription, startDate])
}

model Diploma {
  id               String   @id @default(auto()) @map("_id") @db.ObjectId
  longDescription  String
  shortDescription String
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  // Relations
  examPapers ExamPaper[]
  domainScopes DomainScope[]

  @@unique([longDescription, shortDescription])
}

model Division {
  id               String   @id @default(auto()) @map("_id") @db.ObjectId
  longDescription  String
  shortDescription String
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  // Relations
  examPapers ExamPaper[]
  domainScopes DomainScope[]

  @@unique([longDescription, shortDescription])
}

model ExaminationCenter {
  id          String   @id @default(auto()) @map("_id") @db.ObjectId
  description String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@unique([description])
}

// Sujet d'annales (conteneur d'exercices)
model ExamPaper {
  id String @id @default(auto()) @map("_id") @db.ObjectId

  // Métadonnées administratives
  label       String // ex : "Métropole juin 2024 Jour 1"
  sessionYear Int // ex : 2024 (année scolaire de la session)
  sessionDay  String? // ex : "Jour 1", "Jour 2", "Sujet A", optionnel
  source      ExamPaperSource @default(OFFICIEL)
  sourceUrl   String? // URL de la source si disponible (APMEP, Labolycee, etc.)

  // Date réelle de l'examen
  examDay   Int? // Jour de l'examen (1-31), optionnel
  examMonth Int? // Mois de l'examen (1-12), optionnel
  examYear  Int? // Année de l'examen, optionnel

  // Références pédagogiques (hiérarchie complète)
  diplomaId String  @db.ObjectId
  diploma   Diploma @relation(fields: [diplomaId], references: [id])

  divisionId String?   @db.ObjectId // Optionnel (ex: Brevet)
  division   Division? @relation(fields: [divisionId], references: [id])

  gradeId String @db.ObjectId
  grade   Grade  @relation(fields: [gradeId], references: [id])

  // Le Teaching est le point d'ancrage principal (ex: "Spé Maths Terminale")
  teachingId String   @db.ObjectId
  teaching   Teaching @relation(fields: [teachingId], references: [id])

  // Association au programme scolaire
  curriculumId String?     @db.ObjectId // Optionnel (ex: Brevet)
  curriculum   Curriculum? @relation(fields: [curriculumId], references: [id])

  // Centres d'examen (many-to-many via array d'IDs)
  examinationCenterIds String[] @default([]) @db.ObjectId

  // URLs du sujet complet
  subjectUrl String? // URL du PDF complet

  // Métadonnées globales du sujet
  totalDuration Int? // Durée totale en minutes
  totalPoints   Int? // Total de points

  // DEPRECATED: Métadonnées déplacées au niveau Exercise
  // Ces champs restent pour compatibilité mais ne sont plus utilisés
  domainIds           String[]  @default([]) @db.ObjectId /// @deprecated Utiliser Exercise.themeIds
  themeIds            String[]  @default([]) @db.ObjectId /// @deprecated Utiliser Exercise.themeIds
  correctionUrl       String? /// @deprecated Utiliser Correction ou ExerciseCorrection
  estimatedDuration   Int? /// @deprecated Utiliser Exercise.estimatedDuration
  estimatedDifficulty Int? /// @deprecated Utiliser Exercise.estimatedDifficulty
  summary             String? /// @deprecated Utiliser Exercise.summary
  enrichmentStatus    String    @default("pending") /// @deprecated Utiliser Exercise.enrichmentStatus
  enrichedAt          DateTime? /// @deprecated Utiliser Exercise.enrichedAt

  // Relations
  exercises   Exercise[] // Les exercices contenus dans ce sujet
  corrections Correction[] // Corrections globales (optionnel)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([label, sessionYear, teachingId])
}

enum ExamPaperSource {
  OFFICIEL
  APMEP
  LABOLYCEE
  AUTRE
}

enum ExerciseType {
  NORMAL
  QCM
  TRUE_FALSE
  OTHER
}

// Exercice d'annales (unité de recherche)
model Exercise {
  id String @id @default(auto()) @map("_id") @db.ObjectId

  // Traçabilité du sujet parent
  examPaperId String    @db.ObjectId
  examPaper   ExamPaper @relation(fields: [examPaperId], references: [id], onDelete: Cascade)

  // Position dans le sujet
  exerciseNumber Int // 1, 2, 3...
  label          String? // "Exercice 3", "Partie A", "Question de synthèse"
  points         Int? // Points attribués à cet exercice
  pageStart      Int? // Page de debut (1-based)
  pageEnd        Int? // Page de fin (1-based)
  exerciseType   ExerciseType? @default(NORMAL) // Type d'exercice (QCM, vrai/faux, etc.)

  // Titre et énoncé (pour recherche full-text future)
  title     String? // ex: "Titrage acide-base d'un vinaigre"
  statement String? @db.String // Énoncé complet (extrait via OCR)

  // Tagging pédagogique précis (au niveau exercice)
  themeIds String[] @default([]) @db.ObjectId // Thèmes couverts dans CET exercice

  // URLs spécifiques (optionnel si découpage des PDFs)
  exerciseUrl   String? // URL de l'exercice isolé
  correctionUrl String? // URL de la correction isolée

  // Métadonnées enrichies (via IA)
  estimatedDuration   Int? // Durée estimée en minutes pour CET exercice
  estimatedDifficulty Int? // Difficulté 1-5
  summary             String? // Résumé automatique de l'exercice
  keywords            String[] @default([]) // Mots-clés extraits automatiquement

  // Statut d'enrichissement
  enrichmentStatus String    @default("pending") // "pending" | "completed" | "failed"
  enrichedAt       DateTime? // Date d'enrichissement

  // Relations
  corrections ExerciseCorrection[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([examPaperId, exerciseNumber])
}

// Corrections spécifiques à un exercice
model ExerciseCorrection {
  id String @id @default(auto()) @map("_id") @db.ObjectId

  exerciseId String   @db.ObjectId
  exercise   Exercise @relation(fields: [exerciseId], references: [id], onDelete: Cascade)

  source String // "APMEP", "YouTube - Prof Dupont", etc.
  url    String // Lien vers la correction
  type   String @default("pdf") // "pdf", "video", "html"

  // Métadonnées optionnelles
  quality Int? // Note de qualité 1-5
  author  String? // Auteur si connu

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([exerciseId, source, url])
}

// Corrections externes pour un sujet d'examen
model Correction {
  id String @id @default(auto()) @map("_id") @db.ObjectId

  examPaperId String    @db.ObjectId
  examPaper   ExamPaper @relation(fields: [examPaperId], references: [id], onDelete: Cascade)

  source String // "APMEP", "LaboLycée", "Académie de Paris", etc.
  url    String // lien vers la correction
  type   String @default("pdf") // "pdf", "video", "html"

  // Métadonnées optionnelles
  quality Int? // note de qualité 1-5
  author  String? // auteur si connu

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([examPaperId, source, url])
}

model Grade {
  id               String   @id @default(auto()) @map("_id") @db.ObjectId
  longDescription  String
  shortDescription String
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  // Relations
  teachings  Teaching[]
  examPapers ExamPaper[]
  domainScopes DomainScope[]

  @@unique([longDescription, shortDescription])
}

enum Role {
  USER
  ADMIN
}

model Session {
  id           String   @id @default(auto()) @map("_id") @db.ObjectId
  sessionToken String   @unique @map("session_token")
  userId       String   @db.ObjectId
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")
}

model Subject {
  id               String   @id @default(auto()) @map("_id") @db.ObjectId
  longDescription  String
  shortDescription String
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  // Relations
  teachings Teaching[]
  domains   Domain[]

  @@unique([longDescription, shortDescription])
}

model Theme {
  id               String  @id @default(auto()) @map("_id") @db.ObjectId
  longDescription  String
  shortDescription String?

  domainId String  @db.ObjectId
  domain   Domain @relation(fields: [domainId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model User {
  id            String          @id @default(auto()) @map("_id") @db.ObjectId
  name          String?
  email         String?         @unique
  emailVerified DateTime?       @map("email_verified")
  image         String?
  accounts      Account[]
  sessions      Session[]
  roles         Role            @default(USER)
  // Optional for WebAuthn support
  Authenticator Authenticator[]
  createdAt     DateTime        @default(now())
  updatedAt     DateTime        @updatedAt
}

model VerificationToken {
  id         String   @id @default(auto()) @map("_id") @db.ObjectId
  identifier String
  token      String
  expires    DateTime

  @@unique([identifier, token])
}

enum DbMigrationStatus {
  RUNNING
  APPLIED
  FAILED
}

model DbMigration {
  id String @id @default(auto()) @map("_id") @db.ObjectId

  // Identifiant stable de migration (souvent basé sur le nom de fichier)
  name     String            @unique
  checksum String
  status   DbMigrationStatus @default(RUNNING)

  startedAt  DateTime  @default(now())
  finishedAt DateTime?
  error      String?

  @@map("migrations")
}
